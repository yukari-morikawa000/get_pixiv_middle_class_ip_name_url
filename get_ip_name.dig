# digdag.dig (K8s Jobã®ãƒ©ãƒƒãƒ‘ãƒ¼)

_export:
  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‘ã‚¹ã‚’å®šç¾© (CI/CDã§æœ€æ–°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹å‰æ)
  docker: asia-northeast1-docker.pkg.dev/hogeticlab-legs-prd/ip-name-url/pixiv-ip:latest

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©å (ã“ã‚ŒãŒUIã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰ã«ãªã‚Šã¾ã™)
+pixiv_scraper_job_workflow:
  _retry: 3
  _command_timeout: 6h

  +run_k8s_job:
    # ğŸ’¡ k8s.job> ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦Kubernetes Jobã‚’æŠ•å…¥
    k8s.job>:
      # Kubernetes Jobå®šç¾©ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§è¨˜è¿°
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: pixiv-scraper-job-${session_uuid}
        namespace: collectro # â¬…ï¸ ä»¥å‰ã®YAMLã‹ã‚‰å–å¾—
      spec:
        backoffLimit: 0
        template:
          spec:
            serviceAccountName: collectro
            containers:
            - name: pixiv-scraper
              image: "${_export.docker}" # â¬…ï¸ ä¸Šã® _export ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’ç¶™æ‰¿
              command:
                - "python"
                - "unified_pixiv_search.py"
              env:
                - name: GCP_PROJECT_ID
                  value: "hogeticlab-legs-prd"
            restartPolicy: Never